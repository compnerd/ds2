name: build

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  windows:
    runs-on: windows-latest

    strategy:
      matrix:
        arch: ['Win32', 'x64'] # ['ARM', 'ARM64']

    steps:
      - uses: actions/checkout@v2

      - name: Install Build Tools
        run: choco install winflexbison3

      - name: Configure
        run: cmake -B ${{ github.workspace }}/build -D CMAKE_BUILD_TYPE=Release -G "Visual Studio 16 2019" -A ${{ matrix.arch }} -S ${{ github.workspace }}
      - name: Build
        run: cmake --build ${{ github.workspace }}/build --config Release

  mingw:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    strategy:
      fail-fast: false
      matrix:
        include: [
          { msystem: ucrt64, prefix: mingw-w64-ucrt-x86_64 },
          # disable clang64 as the packaging seems incorrect:
          # ...: error while loading shared libraries: librhash.dll: cannot open shared object file: No such file or directory
          # { msystem: clang64, prefix: mingw-w64-clang-x86_64 },
        ]
    
    steps:
      - uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msystem }}
          install: >-
            flex
            bison
            ${{ matrix.prefix }}-cmake
            ${{ matrix.prefix }}-gcc
            ${{ matrix.prefix }}-ninja

      - uses: actions/checkout@v2

      - name: Configure
        run: cmake -B $(cygpath -u '${{ github.workspace }}/build') -D CMAKE_BUILD_TYPE=Release -G Ninja -S $(cygpath -u '${{ github.workspace }}')
      - name: Build
        run: cmake --build $(cygpath -u '${{ github.workspace }}/build') --config Release

  macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v2
      - uses: seanmiddleditch/gha-setup-ninja@master

      - name: Configure
        run: cmake -B ${{ github.workspace }}/out -D CMAKE_BUILD_TYPE=Release -G Ninja -S ${{ github.workspace }}
      - name: Build
        run: cmake --build ${{ github.workspace }}/out --config Release

  linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - run: |
          sudo apt-get install -qq --no-install-recommends flex bison ninja-build

      - name: Configure
        run: cmake -B ${{ github.workspace }}/build -D CMAKE_BUILD_TYPE=Release -G Ninja -S ${{ github.workspace }}
      - name: Build
        run: cmake --build ${{ github.workspace }}/build --config Releaase
